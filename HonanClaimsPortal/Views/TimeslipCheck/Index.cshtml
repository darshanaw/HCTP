@model HonanClaimsWebApi.Models.TimeslipCheck.TimeslipReturnModel

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- MOMENT JS-->
<script src="~/Content/vendor/moment/min/moment-with-locales.min.js"></script>
<!-- DATETIMEPICKER-->
<link href="~/Content/vendor/eonasdan-bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css" rel="stylesheet" />
<script src="~/Content/vendor/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>




<div class="content-wrapper">
    <h3>
        Check Billable Time
    </h3>
    <div class="row">
        <div class="col-md-12">
            <fieldset class="mb-0">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="col-sm-3 control-label input-sm">Claim Team</label>
                            <div class="col-sm-9">
                                @Html.DropDownListFor(m => m.ClaimTeam,
                            new SelectList(Model.ClaimTeam, "Code", "Text"),
                            "--Select--",
                            new { @class = "form-control input-sm", @onchange = "comboChange()" })
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb">
                        <div class="form-group">
                            <label class="col-sm-3 control-label input-sm">Service by</label>
                            <div class="col-sm-9">
                                @Html.DropDownListFor(m => m.ServiceBy,
                            new SelectList(Model.ServiceBy, "Code", "Text"),
                            "--Select--",
                            new { @class = "form-control input-sm", @onchange = "comboChange()" })
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="col-sm-3 control-label input-sm">Claim</label>
                            <div class="col-sm-9">
                                @Html.DropDownListFor(m => m.Claim,
                            new SelectList(Model.Claim, "Code", "Text"),
                            "--Select--",
                            new { @class = "form-control input-sm", @onchange = "comboChange()" })
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="col-sm-3 control-label input-sm">Account</label>
                            <div class="col-sm-9">
                                @Html.DropDownListFor(m => m.Account,
                            new SelectList(Model.Account, "Code", "Text"),
                            "--Select--",
                            new { @class = "form-control input-sm", @onchange = "comboChange()" })
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb">
                        <div class="form-group">
                            <label class="col-sm-3 control-label input-sm">Date from</label>
                            <div class="col-sm-9">
                                <div id="datetimepicker1" class="input-group date">
                                    @Html.TextBoxFor(o => o.Datefrom, new { @class = "form-control input-sm" })
                                    <span class="input-group-addon" id="basic-addon2"><i class="fa fa-calendar" aria-hidden="true"></i></span>
                                    <span style="color:red;" id="errorDate"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb">
                        <div class="form-group">
                            <label class="col-sm-3 control-label input-sm">Date to</label>
                            <div class="col-sm-9">
                                <div id="datetimepicker2" class="input-group date">
                                    @Html.TextBoxFor(o => o.Dateto, new { @class = "form-control input-sm",@style= "z-index: auto" })
                                    <span class="input-group-addon" id="basic-addon2"><i class="fa fa-calendar" aria-hidden="true"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="col-md-12 ">
                            <div class="pull-right">
                                <button id="clearFilter" type="button" class="btn btn-default mr-20">Clear Filter</button>
                                <button id="filterList" type="button" class="btn btn-primary">Filter Billable</button>
                            </div>
                        </div>
                    </div>
                </div>

            </fieldset>
        </div>

        <div class="col-md-12">
            <fieldset>
                <div class="col-md-8">
                    <div id="grid1"></div>
                </div>
                <div class="col-md-4">
                    <div class="row mb">
                        <div class="col-md-12">
                            <div class="row mb">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label input-sm">Service By</label>
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(m => m.InnerModeL.Service_By_Name, new { @class = "form-control input-sm", disabled = "disabled" })
                                        @Html.HiddenFor(m => m.InnerModeL.H_Billingsid)
                                        @Html.HiddenFor(m => m.InnerModeL.H_Claimsid)
                                    </div>
                                </div>
                            </div>
                            <div class="row mb">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label input-sm">Claim</label>
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(m => m.InnerModeL.Claim_No, new { @class = "form-control input-sm", disabled = "disabled" })
                                    </div>
                                </div>
                            </div>
                            <div class="row mb">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label input-sm">Is Billable</label>
                                    <div class="col-sm-9">
                                        @Html.CheckBoxFor(m => m.InnerModeL.Is_Billable, new { @class = "input-sm" })
                                    </div>
                                </div>
                            </div>
                            <div class="row mb">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label input-sm">Rate P/Hr</label>
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(m => m.InnerModeL.Rate, new { @class = "form-control input-sm", disabled = "disabled" })
                                    </div>
                                </div>
                            </div>
                            <div class="row mb">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label input-sm">Service Date</label>
                                    <div class="col-sm-9">
                                        <div id="datetimepicker3" class="input-group date">
                                            @Html.TextBoxFor(o => o.InnerModeL.Service_Date, new { @class = "form-control input-sm" })
                                            <span class="input-group-addon" id="basic-addon2"><i class="fa fa-calendar" aria-hidden="true"></i></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mb">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label input-sm">Start Time</label>
                                    <div class="col-sm-9">
                                        @Html.DropDownListFor(m => m.InnerModeL.Start_Time_HH, Enumerable.Range(0, 24).Select(i => new
                                    SelectListItem
                                   {
                                       Text = i.ToString().PadLeft(2, '0'),
                                       Value = i.ToString().PadLeft(2, '0')
                                   }), new { @class = "form-control input-sm" })

                                        @Html.DropDownListFor(m => m.InnerModeL.Start_Time_MM, Enumerable.Range(0, 60).Select(i => new
                                         SelectListItem
                                   {
                                       Text = i.ToString().PadLeft(2, '0'),
                                       Value = i.ToString().PadLeft(2, '0')
                                   }), new { @class = "form-control input-sm" })
                                    </div>
                                </div>
                            </div>
                            <div class="row mb">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label input-sm">End Time</label>
                                    <div class="col-sm-9">
                                        @Html.DropDownListFor(m => m.InnerModeL.End_Time_HH, Enumerable.Range(0, 24).Select(i => new
                                    SelectListItem
                                   {
                                       Text = i.ToString().PadLeft(2, '0'),
                                       Value = i.ToString().PadLeft(2, '0')
                                   }), new { @class = "form-control input-sm" })

                                        @Html.DropDownListFor(m => m.InnerModeL.End_Time_MM, Enumerable.Range(0, 60).Select(i => new
                                SelectListItem
                                   {
                                       Text = i.ToString().PadLeft(2, '0'),
                                       Value = i.ToString().PadLeft(2, '0')
                                   }), new { @class = "form-control input-sm" })
                                    </div>
                                </div>
                            </div>

                            <div class="row mb">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label input-sm">Qty(Mins)</label>
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(m => m.InnerModeL.Qty_Mins, new { @class = "form-control input-sm", disabled = "disabled" })
                                    </div>
                                </div>
                            </div>
                            <div class="row mb">
                                <div class="form-group">
                                    <label class="col-sm-3 control-label input-sm">Billable</label>
                                    <div class="col-sm-9">
                                        @Html.TextBoxFor(m => m.InnerModeL.Billable, new { @class = "form-control input-sm", disabled = "disabled" })
                                    </div>
                                </div>
                            </div>

                            <div class="row mb">
                                <div class="form-group">
                                    @Html.TextAreaFor(m => m.InnerModeL.Work_Done, new { @class = "form-control input-sm resize-block billable-txtarea" })
                                </div>
                            </div>
                            <div class="pull-right">
                                <button id="Markaschecked" type="button" class="btn btn-default">Mark as Checked</button>
                                <button id="nonbillable" type="button" class="btn btn-default">Mark as Non Billable</button>
                                <button id="skipnext" type="button" class="btn btn-default">Skip Next One</button>
                            </div>
                        </div>

                    </div>
                </div>
            </fieldset>
        </div>
    </div>
</div>

@*<input type="button" value="test" id="test" />*@
<script>
    $("#test").on("click", function () {
        var ids = [];
        var grid = $("#grid1").data("kendoGrid");
        grid.select().each(function () {
            var dataItem = grid.dataItem($(this));
            ids.push(dataItem.BillingId);
        });
    });

    $(document).ready(function () {

        $("#InnerModeL_Is_Billable").attr('value', 'true');

        $("#InnerModeL_Is_Billable").on('change', function () {
            if ($(this).is(':checked')) {
                $(this).attr('value', 'true');
            } else {
                $(this).attr('value', 'false');
            }

        });

        $('#datetimepicker1').datetimepicker({
            format: 'DD/MM/YYYY'
        });

        $('#datetimepicker2').datetimepicker({
            format: 'DD/MM/YYYY'
        });

        $('#datetimepicker3').datetimepicker({
            format: 'DD/MM/YYYY'
        });

        $("#datetimepicker1").on("dp.change", function (e) {
            var tdate = $("#datetimepicker1").data().date;
            $("#Datefrom").val(tdate);
        });

        $("#datetimepicker3").on("dp.change", function (e) {
            var tdate = $("#datetimepicker3").data().date;
            $("#Service_Date").val(tdate);
        });


        $("#datetimepicker2").on("dp.change", function (e) {
            var tdate = $("#datetimepicker2").data().date;
            var tdate1 = $("#datetimepicker1").data().date;
            $("#Dateto").val(tdate);
            if (tdate < tdate1) {
                $("#errorDate").text("From date must be less than To date");
            } else {
                $("#errorDate").text("");
                LoadGridDetail();
            }
        });

        LoadGridDetail();

        $('#clearFilter').click(function () {
            $('#ClaimTeam').val("");
            $('#ServiceBy').val("")
            $('#Claim').val("");
            $('#Datefrom').val("");
            $('#Dateto').val("");
            LoadGridDetail();
        });

        $('#filterList').click(function () {
            LoadGridDetail();
        })
    })

    function LoadGridDetail() {
        var claimTeam = null;
        var accountId = null;
        var serviceBy = null;
        var claimId = null;
        var fromDate = null;
        var toDate = null;

        //Get value list
        var c = $('#ClaimTeam').val();
        if (c != null && c != "") { claimTeam = c }
        var o = $('#Account').val();
        if (o != null && o != "") { accountId = o }
        var cl = $('#ServiceBy').val();
        if (cl != null && cl != "") { serviceBy = cl }
        var s = $('#Claim').val();
        if (s != null && s != "") { claimId = s }
        var a = $('#Datefrom').val();
        if (a != null && a != "") { fromDate = a }
        var t = $('#Dateto').val();
        if (t != null && a != "") { toDate = t }
        //load grid list
        $("#grid1").kendoGrid({
            dataSource: {
                type: "json",
                transport: {
                    read: "/TimeslipCheck/GetMyTimeslipCheck?claimTeam=" + claimTeam + "&accountId=" + accountId + "&serviceBy=" + serviceBy + "&claimId=" + claimId + "&fromDate=" + fromDate + "&toDate=" + toDate
                },
                pageSize: 10
            },
            height: 600,
            sortable: true,
            selectable: "multiple",
            change: onChange,
            pageable: {
                refresh: true,
                pageSizes: true,
                buttonCount: 5
            },
            columns: [
                {
                    hidden: true,
                    field: "BillingId",
                    title: "BillingId"
                },
                {
                    field: "ClaimRefNo",
                    title: "Claims Ref ",
                },
                {
                    field: "ServiceBy",
                    title: "Service By",
                }, {
                    //field: "ServiceDate",
                    title: "Service Date",
                    template: "#if(ServiceDate === null){# '' #}else{# #= kendo.toString(kendo.parseDate(ServiceDate), 'dd-MM-yyyy') #  #}#"
                }, {
                    field: "StartTime",
                    title: "Start Time",
                },
                {
                    field: "Qty",
                    title: "Qty(Mins)",
                },
                {
                    field: "Billable",
                    title: "Billable $$",
                }],
            dataBound: function () {
                $(".checkbox").bind("change", function (e) {
                    $(e.target).closest("tr").toggleClass("k-state-selected");
                });
            }
        });

        function onChange(arg) {
            $('tr').find('[type=checkbox]').prop('checked', false);
            $('tr.k-state-selected').find('[type=checkbox]').prop('checked', true);
            //var dataItem = arg.sender._data[0];
            //setTextFields(dataItem);
            var dataItem = this.dataItem(this.select());
            setTextFields(dataItem);
        }
    }

    function comboChange() {
        LoadGridDetail();
    }

    function setTextFields(dataItem) {
        $.get("/TimeslipCheck/GetBillingRecords?billingId=" + dataItem.BillingId, function (data) {
            $('#InnerModeL_H_Billingsid').val(data.H_Billingsid);
            $('#InnerModeL_Service_By_Name').val(data.Service_By_Name);
            $('#InnerModeL_Is_Billable').val(data.Is_Billable);
            $('#InnerModeL_H_Claimsid').val(data.H_Claimsid);
            if (data.Is_Billable) { $('#InnerModeL_Is_Billable').prop("checked", true); } else { $('#InnerModeL_Is_Billable').prop("checked", false); }
            $('#InnerModeL_Rate').val(data.Rate);
            $('#InnerModeL_Claim_No').val(data.Claim_No);


            if (data.Service_Date != null && data.Service_Date != "") {
                var date = new Date(data.Service_Date);
                var month = date.getMonth() + 1;
                data.Service_Date = date.getDate() + "/" + month + "/" + date.getFullYear();
                $("#InnerModeL_Service_Date").val(data.Service_Date);
            }

            if (0 <= data.Start_Time_HH && data.Start_Time_HH <= 9) {
                data.Start_Time_HH = "0" + data.Start_Time_HH;
            }
            if (0 <= data.Start_Time_MM && data.Start_Time_MM <= 9) {
                data.Start_Time_MM = "0" + data.Start_Time_MM;
            }
            if (0 <= data.End_Time_HH && data.End_Time_HH <= 9) {
                data.End_Time_HH = "0" + data.End_Time_HH;
            }
            if (0 <= data.End_Time_MM && data.End_Time_MM <= 9) {
                data.End_Time_MM = "01";
            }
            $('#InnerModeL_Start_Time_HH').val(data.Start_Time_HH);
            $('#InnerModeL_Start_Time_MM').val(data.Start_Time_MM);
            $('#InnerModeL_End_Time_HH').val(data.End_Time_HH);
            $('#InnerModeL_End_Time_MM').val(data.End_Time_MM);

            $('#InnerModeL_Qty_Mins').val(data.Qty_Mins);
            $('#InnerModeL_Billable').val(data.Billable);
        });
    }

    function clearTextFileds() {
        $('#InnerModeL_H_Billingsid').val('');
        $('#InnerModeL_Service_By_Name').val('');
        $('#InnerModeL_Is_Billable').val('');
        $('#InnerModeL_H_Claimsid').val('');
        $('#InnerModeL_Is_Billable').prop("checked", false);
        $('#InnerModeL_Rate').val('');
        $('#InnerModeL_Claim_No').val('');
        $("#InnerModeL_Service_Date").val('');
        $('#InnerModeL_Start_Time_HH').val('');
        $('#InnerModeL_Start_Time_MM').val('');
        $('#InnerModeL_End_Time_HH').val('');
        $('#InnerModeL_End_Time_MM').val('');
        $('#InnerModeL_Qty_Mins').val('');
        $('#InnerModeL_Billable').val('');
    }

    $('#Markaschecked').click(function () {
        var id = $('#InnerModeL_H_Billingsid').val();
        var claimId = $('#InnerModeL_H_Claimsid').val();
        var serviceDate = $('#InnerModeL_Service_Date').val();

        var startTimeHH = $('#InnerModeL_Start_Time_HH').val();
        var startTimeMM = $('#InnerModeL_Start_Time_MM').val();
        var endTimeHH = $('#InnerModeL_End_Time_HH').val();
        var endTimeMM = $('#InnerModeL_End_Time_MM').val();


        var ids = "";
        var count = 0;
        var grid = $("#grid1").data("kendoGrid");
        grid.select().each(function () {
            var dataItem = grid.dataItem($(this));
            ids = dataItem.BillingId + "," + ids;
            count = count + 1;
        });
        if (count == 1) {
            if (id != null && id != "" && claimId != null && claimId != "" && (startTimeHH != null && startTimeHH != "") && (startTimeMM != "" && startTimeMM != null) && (endTimeHH != "" && endTimeHH != null) && (endTimeMM != "" && endTimeMM != null)) {
                $.get("/TimeslipCheck/MarkAsChecked?billingId=" + id + "&serviceDate=" + serviceDate + "&startTimeHH=" + startTimeHH + "&startTimeMM=" + startTimeMM + "&endTimeHH=" + endTimeHH + "&endTimeMM=" + endTimeMM + "&claimId=" + claimId, function (data) {
                    if (data == false) {
                        bootbox.alert("Error in Updating mark as checked");
                    } else {
                        $("#grid1").data("kendoGrid").dataSource.read();
                        bootbox.alert("mark as checked");
                        clearTextFileds();
                    }
                });
            }
            else {
                bootbox.alert("Please fill all the data ");
            }
        }
        else {
            $.get("/TimeslipCheck/MarkAsCheckedPost?billingIds=" + ids, function (data) {
                if (data == false) {
                    bootbox.alert("Error in Updating mark as checked");
                } else {
                    $("#grid1").data("kendoGrid").dataSource.read();
                    bootbox.alert("mark as checked");
                }
            });
        }

        // }
    })


    $('#nonbillable').click(function () {

        $("#InnerModeL_Is_Billable").attr('checked', false);
        var id = $('#InnerModeL_H_Billingsid').val();
        var claimId = $('#InnerModeL_H_Claimsid').val();
        var serviceDate = $('#InnerModeL_Service_Date').val();

        var startTimeHH = $('#InnerModeL_Start_Time_HH').val();
        var startTimeMM = $('#InnerModeL_Start_Time_MM').val();
        var endTimeHH = $('#InnerModeL_End_Time_HH').val();
        var endTimeMM = $('#InnerModeL_End_Time_MM').val();

        var ids = "";
        var count = 0;
        var grid = $("#grid1").data("kendoGrid");
        grid.select().each(function () {
            var dataItem = grid.dataItem($(this));
            ids = dataItem.BillingId + "," + ids;
            count = count + 1;
        });

        if (count == 1) {
            if (id != null && id != "" && claimId != null && claimId != "" && (startTimeHH != null && startTimeHH != "") && (startTimeMM != "" && startTimeMM != null) && (endTimeHH != "" && endTimeHH != null) && (endTimeMM != "" && endTimeMM != null)) {
                $.get("/TimeslipCheck/MarkAsChecked?billingId=" + id + "&serviceDate=" + serviceDate + "&startTimeHH=" + startTimeHH + "&startTimeMM=" + startTimeMM + "&endTimeHH=" + endTimeHH + "&endTimeMM=" + endTimeMM + "&claimId=" + claimId, function (data) {
                    if (data == false) {
                        bootbox.alert("Error in Updating mark as checked");
                    } else {
                        $("#grid1").data("kendoGrid").dataSource.read();
                        bootbox.alert("mark as checked");
                        clearTextFileds();
                    }
                });
            }
        }
        else {
            $.get("/TimeslipCheck/MarkAsNonBillablePost?billingIds=" + ids, function (data) {

                if (data == false) {
                    bootbox.alert("Error in Updating Non billable");
                } else {
                    $("#grid1").data("kendoGrid").dataSource.read();
                    bootbox.alert("mark as Non Billable");
                }
            });
        }
    })

    $('#skipnext').click(function () {

        //clearTextFileds();
        var Hid = $('#InnerModeL_H_Billingsid').val();
        if (Hid != null && Hid != "") {
            var grid = $("#grid1").data("kendoGrid");
            var selectedRow = grid.select();
            var index = selectedRow.index();

            if (index != -1) {
                var data = $("#grid1").data("kendoGrid").dataSource.view();
                var newind = index + 1;

                $(selectedRow).removeClass("k-state-selected");

                if (data.length >= newind) {
                    var id = data[newind].uid;
                    grid.select("tr:eq(" + newind + ")")
                    setTextFields(data[newind]);
                    debugger;
                }
            }
        }
    })
</script>
