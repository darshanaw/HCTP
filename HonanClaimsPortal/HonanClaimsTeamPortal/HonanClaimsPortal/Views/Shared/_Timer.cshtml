
@*http://www.jqueryscript.net/time-clock/Count-Up-Timer-Stopwatch-jQuery-Countimer.html*@
    @*<link href="~/Content/TimerAssets/countup/jquery.countup.css" rel="stylesheet" />
        <script src="~/Content/TimerAssets/countup/jquery.countup.js"></script>
        <script src="~/Content/TimerAssets/js/script.js"></script>

        <div id="countdown" style="padding-top:6%;margin-left:6px"></div>
*@

<div id="floatingTimerWindow" style="display:none">
<div style="font-size:25px;font-weight:bold"><span id="countDownNumberTimer"></span> Seconds</div>
<br />
<input type="button" class="btn btn-primary" id="btnTimerBillNow" value="Bill Now" />   
<input type="button" class="btn btn-default" id="btnTimerNoBill" value="No Bill" />  
</div>


<script src="~/Content/CountDownTimer/dist/ez.countimer.min.js"></script>
<script src="~/Content/CountDownTimer/src/countimer.js"></script>

<input type="hidden" id="hdnHiddenStartTime" />
<input type="hidden" id="hdnHiddenEndTime" />
<input type="hidden" id="hdnStateOfTimer" />

@*<div class="timer inline" id="timerCoutDiv" style="padding-top:0%;margin-left:6px;font-size:25px;font-weight:bold"></div>*@
@*<div class="inline">Stop Timer</div>*@
<div class="list-group-item" id="timerBlock" style="padding:0px 15px;background-color:transparent;border:none;display:none">
    <div class="media-box">
        <div class="pull-left" style="margin-right:0px">
            <span class="fa-stack">
                <em class="fa fa-circle fa-stack-2x text-danger" style="line-height:40px"></em>
                <em class="fa fa-clock-o fa-stack-1x fa-inverse text-white" style="line-height:40px"></em>
            </span>
        </div>
        <div class="media-box-body clearfix">
            <div class="media-box-heading">
                <div class="timer inline" id="timerCoutDiv" style="padding-top:0%;margin-left:6px;font-size:25px;font-weight:bold"></div>
                <a href="javascript:void(0);" id="btnStopTimer"  class="text-danger m0">Stop Timer</a>
            </div>            
        </div>
    </div>
</div>
    @*<p>
        <button class="btn btn-default" onClick="$('.timer').countimer('start');">Start</button>
        <button class="btn btn-warning" onClick="$('.timer').countimer('stop');">Stop</button>
        <button class="btn btn-success" onClick="$('.timer').countimer('resume');">Resume</button>
    </p>*@

<script type="text/javascript">

    function onTimerTimeSlip()
    {
        //loadBillingDetail('');
        //$("#ActivityTasksDetailModal").modal("show");
    }
    
    $(document).ready(function () {

        $("#hdnStateOfTimer").val("nutral");
        $("#btnStopTimer").hide();
      
        var myWindow = $("#floatingTimerWindow");
        myWindow.css('display', 'block');
        $("#timerBlock").css("display", "block");
        myWindow.kendoWindow({

            width: "200px",
            title: "Billing Starts In",
            visible: false,
            actions: [
                //"Pin",
                //"Minimize",
                //"Maximize",
                //"Close"
            ]
        }).data("kendoWindow").center().open();

        var myCounter = new Countdown({
            seconds: 30,  // number of seconds to count down
            onUpdateStatus: function (sec) { $("#countDownNumberTimer").html(sec) }, // callback for each second console.log(sec);
            onCounterEnd: function () {

                if ($("#hdnStateOfTimer").val() == "nutral") {
                    startBilling(myWindow);
                }
            } // final action
        });

        myWindow.data("kendoWindow").open();

        $('.timer').countimer({
            autoStart: false
        });

        $("#btnTimerBillNow").click(function () {

            startBilling(myWindow);

        });

        $("#btnTimerNoBill").click(function () {

            $('#timerCoutDiv').countimer('stop');
            myCounter.stop();
            myWindow.data("kendoWindow").close();
            

        });

        $("#btnStopTimer").click(function () {
          
             stopBilling(myWindow);           
        });
             
     
        myCounter.start();

    });


    function startBilling(myWindow)
    {
        $("#hdnStateOfTimer").val("started");
        $("#btnStopTimer").show();
        var dt = new Date();
       // var time = dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();

        $("#hdnHiddenStartTime").val(dt);
      
        $('#timerCoutDiv').countimer('start');
        myWindow.data("kendoWindow").close();
    }

    function stopBilling(myWindow)
    {    
       
        var dt = new Date();
       // var time = dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds();

        if ($("#hdnStateOfTimer").val() != "ended")
            $("#hdnHiddenEndTime").val(dt);

        $("#hdnStateOfTimer").val("ended");       
           
        $('#timerCoutDiv').countimer('stop');
        $("#btnStopTimer").hide();
            //Set start time

            

            var dtStart = new Date($("#hdnHiddenStartTime").val());

            var hours = dtStart.getHours() % 12;
            hours = hours ? hours : 12;
            var mid = "";
            if (dtStart.getHours() > 11)
                mid = 'PM';
            else
                mid = 'AM';

            //var hours = (dtStart.getHours() + 24 - 2) % 24;
            //var mid = 'AM';
            //if (hours == 0) { //At 00 hours we need to show 12 am
            //    hours = 12;
            //}
            //else if (hours > 12) {
            //    hours = hours % 12;
            //    mid = 'PM';
            //}


            var startTime = pad(hours, 2) + ":" + pad(dtStart.getMinutes(),2) + " " + mid;

            //Set end time
            var end_time = new Date($("#hdnHiddenEndTime").val());
            

            var hours_end = end_time.getHours() % 12;
            hours_end = hours_end ? hours_end : 12; 
            var mid_end = "";
            if (end_time.getHours() > 11)
                 mid_end = 'PM';
            else 
                 mid_end = 'AM';
            //var hours_end = (end_time.getHours() + 24 - 2) % 24;
            //var mid_end = 'AM';
            //if (hours_end == 0) { //At 00 hours we need to show 12 am
            //    hours_end = 12;
            //}
            //else if (hours_end > 12) {
            //    hours_end = hours_end % 12;
            //    mid_end = 'PM';
            //}

            var endTimerVal = pad(hours_end, 2) + ":" + pad(end_time.getMinutes(), 2) + " " + mid_end;

            var diff = (new Date("1970-1-1 " + pad(hours_end, 2) + ":" + pad(end_time.getMinutes(), 2) + ":" + pad(end_time.getSeconds(), 2) + " " + mid_end) - new Date("1970-1-1 " + pad(hours, 2) + ":" + pad(dtStart.getMinutes(), 2) + ":" + pad(dtStart.getSeconds(), 2) + " " + mid)) / 1000 / 60;
            
            loadBillingDetail('', startTime, endTimerVal, diff.toFixed(2));

        
    }

    function pad(num, size) {
        var s = "0" + num;
        return s.substr(s.length - size);
    }

    function Countdown(options) {

        var timer,
            instance = this,
            seconds = options.seconds || 10,
            updateStatus = options.onUpdateStatus || function () { },
            counterEnd = options.onCounterEnd || function () { };

        function decrementCounter() {
            updateStatus(seconds);
            if (seconds === 0) {
                counterEnd();
                instance.stop();
            }
            seconds--;
        }

        this.start = function () {
            clearInterval(timer);
            timer = 0;
            seconds = options.seconds;
            timer = setInterval(decrementCounter, 1000);
        };

        this.stop = function () {
            clearInterval(timer);
        };
    }
  
</script>
